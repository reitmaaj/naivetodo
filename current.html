<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Task</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html">Home</a> | 
            <a href="edit.html">New Task</a>
        </header>

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Current Task</h2>
            <a id="editLink" href="#" style="background: #eee; padding: 5px 10px; border-radius: 4px; text-decoration: none; color: #333;">Edit</a>
        </div>
        
        <form>
            <div class="form-group">
                <label for="content">Content</label>
                <textarea id="content" rows="5" readonly></textarea>
            </div>

            <div class="form-group" id="deadlineGroup" style="display: none;">
                <label>Deadline</label>
                <div id="deadlineDisplay" style="padding: 10px; background: #fafafa; border: 1px solid #ddd; border-radius: 4px;"></div>
            </div>

            <div class="form-group">
                <label>Attachments</label>
                <ul id="attachmentList" style="list-style: none; padding: 0;"></ul>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" id="doneBtn" style="flex: 1; background-color: #28a745;">Done</button>
                <button type="button" id="doLaterBtn" class="secondary" style="flex: 1; margin-left: 0;">Do Later</button>
            </div>
        </form>
    </div>
    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const taskId = window.location.hash.substring(1);
            
            if (!taskId) {
                window.location.href = 'index.html';
                return;
            }

            let task = app.getTask(taskId);
            
            // If task not found in cache (e.g. direct link), try to sync
            if (!task) {
                await app.init();
                task = app.getTask(taskId);
            }

            if (task) {
                document.getElementById('editLink').href = `edit.html#${task.id}`;
                document.getElementById('content').value = task.content;
                
                if (task.deadline) {
                    document.getElementById('deadlineGroup').style.display = 'block';
                    document.getElementById('deadlineDisplay').textContent = new Date(task.deadline).toLocaleString();
                } else {
                    document.getElementById('deadlineGroup').style.display = 'none';
                }

                const list = document.getElementById('attachmentList');
                list.innerHTML = '';
                
                if (task.attachment && task.attachment.length > 0) {
                    task.attachment.forEach(att => {
                        const li = document.createElement('li');
                        li.style.marginBottom = '5px';
                        const a = document.createElement('a');
                        a.href = att.url;
                        a.textContent = att.name;
                        a.target = '_blank';
                        li.appendChild(a);
                        list.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'No attachments';
                    li.style.color = '#777';
                    list.appendChild(li);
                }
            } else {
                document.getElementById('content').value = 'Task not found.';
            }

            const loadNextTask = () => {
                const tasks = app.getTasks();
                const otherTasks = tasks.filter(t => t.id !== taskId);
                
                if (otherTasks.length > 0) {
                    const randomTask = otherTasks[Math.floor(Math.random() * otherTasks.length)];
                    window.location.href = `current.html#${randomTask.id}`;
                    window.location.reload();
                } else {
                    alert('No other tasks to display!');
                }
            };

            document.getElementById('doneBtn').addEventListener('click', loadNextTask);
            
            document.getElementById('doLaterBtn').addEventListener('click', async () => {
                const btn = document.getElementById('doLaterBtn');
                btn.disabled = true;
                
                try {
                    await app.patchTask(taskId, {
                        delayed: new Date().toISOString()
                    });
                } catch (e) {
                    console.error('Failed to delay task:', e);
                }
                
                loadNextTask();
            });
        });
    </script>
</body>
</html>
